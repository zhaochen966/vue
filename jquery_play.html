<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 2021-06-14 -->
    <title>宸哥的jQuery音乐播放器</title>
    <!-- css -->
    <link rel="stylesheet" href="./css/index.css">
</head>

<body>
    <div class="wrap">
        <!-- 播放器主体区域 -->
        <div class="play_wrap" id="player">
            <div class="search_bar" v-on:click="searchMusic">
                <img src="images/player_title.png" alt="" />
                <!-- 搜索歌曲 -->
                <input type="text" autocomplete="off" id="searchKey" placeholder="音乐/视频/电台/用户" />
            </div>
            <div class="center_con">
                <!-- 搜索歌曲列表 -->
                <div class='song_wrapper'>
                    <ul class="song_list">
                    </ul>
                    <img src="images/line.png" class="switch_btn" alt="">
                </div>
                <!-- 歌曲信息容器 -->
                <div class="player_con">
                    <img src="images/player_bar.png" class="play_bar" />
                    <!-- 黑胶碟片 -->
                    <img src="images/disc.png" class="disc autoRotate" />
                    <img src="" id="musicCover" class="cover autoRotate" />
                </div>
                <!-- 评论容器 -->
                <div class="comment_wrapper">
                    <h5 class='title'>热门留言</h5>
                    <div class='comment_list'>
                    </div>
                    <img src="images/line.png" class="right_line">
                </div>
            </div>
            <div class="audio_con">
                <audio ref='audio' id="myaudio" src="" controls autoplay loop
                    class="myaudio" autoplay="autoplay"></audio>
                </audio>
            </div>
            <div class="video_con" style="display: none;" id="video_con">
                <video controls="controls" id="mvUrl" src=""></video>
                <div class="mask" onclick="hideVideo_con()"></div>
            </div>
        </div>
    </div>

    <!-- 开发版本的jQuery,正式版本min.js -->
    <script src="./js/jquery-3.2.1.js"></script>
    <!-- 美化alert弹窗 -->
    <script src="./js/alert.js"></script>

    <script>
        //$(function () {  这是简写的形式
        $(document).ready(function(){
            // 歌曲搜索，回车键抬起触发
            $("#searchKey").keyup(function (event) {
                if (event.keyCode == 13) {
                    // 搜索的关键字不为空执行ajax操作
                    if ($("#searchKey").val()) {
                        searchMusic($("#searchKey").val());
                    }else{
                        alert("搜索的关键字不能为空！");
                        //alert('<img src="./java.jpg"/>搜索的关键字不能为空！');
                    }
                }
            });

            // 歌曲搜索，鼠标单击触发此事件
            $("#searchKey").click(function () {
                // 搜索的关键字不为空执行ajax操作
                if ($("#searchKey").val() != null && $("#searchKey").val().trim() != '') {
                    searchMusic($("#searchKey").val());
                }
            });

            // 根据歌曲的播放/暂停：控制中间的滚动
            var myaudio = document.getElementById("myaudio");
            myaudio.onplay = function () {
                $(".player_con").addClass("playing");
            };
            myaudio.onpause = function () {
                $(".player_con").removeClass("playing");
            };


        }); // dom加载函数

        // 根据关键字进行搜索
        function searchMusic(key){
            $.ajax({
                type: "get",
                url: "https://autumnfish.cn/search?keywords=" + key,
                success: function (data) {
                    var musicList = data.result.songs;
                    //先清空列表中的所有内容
                    $('.song_list').empty();  
                    var html = '';
                    $.each(musicList, function(index, item){
                        html += '<li>';
                        html += '<a href="javascript:;" onclick="playMusic(' + item.id + ')"></a>';
                        //html += "<a href=\"#\" onclick=\"playMusic(" + item.id + ");return false;\"></a>"
                        html += '<b>' + item.name + '</b>';
                        // 如果存在mvid就显示mv
                        if(item.mvid){
                            html += '<span><i onclick="getMV(' + item.mvid + ')"></i></span>';
                        }
                        html += '</li>';
                        });
                        $('.song_list').html(html);
                },
                error:function(err){
                    alert("系统异常，请联系管理员！");
                }
            });
        }

        // 播放音乐:隐身而来的是中间的专辑图片和右侧的热门评论
        function playMusic(musicId){
            // 播放音乐
            $.ajax({
                type: "get",
                url: "https://autumnfish.cn/song/url?id=" + musicId,
                success: function (data) {
                    var musicUrl = data.data[0].url;
                    //a、只有修改audio 的src值，才可以播放修改source 的src值却不可以播放
                    //b、在更改src后要加上load();函数：这是js下的函数，不是jquery的那个load()
                    $('#myaudio').attr('src',musicUrl);
                    // 要获取第一个，否则可能会有js报错
                    $('#myaudio').get('0').load();
                    $(".player_con").addClass("playing");
                },
                error:function(err){
                    alert("系统异常，请联系管理员！");
                }
            });
            // 歌曲封面
            $.ajax({
                type: "get",
                url: "https://autumnfish.cn/song/detail?ids=" + musicId,
                success: function (data) {
                    var musicCover = data.songs[0].al.picUrl;
                    $('#musicCover').attr('src',musicCover);
                },
                error:function(err){
                    alert("系统异常，请联系管理员！");
                }
            });
            // 热门评论
            $.ajax({
                type: "get",
                url: "https://autumnfish.cn/comment/hot?type=0&id=" + musicId,
                success: function (data) {
                    var hotComments = data.hotComments;
                    var html = '';
                    $.each(hotComments, function(index, item){
                        html += '<dl>';
                        html += '<dt><img src="' + item.user.avatarUrl + '" alt=""></dt>';
                        html += '<dd class="name">'+ item.user.nickname + '</dd>';
                        html += '<dd class="detail">';
                        html += item.content;
                        html += '</dd></dl>';
                    });
                    $(".comment_list").html(html);
                },
                error:function(err){
                    alert("系统异常，请联系管理员！");
                }
            });
        }

        // 播放mv
        var getMV = function(mvid){
            $.ajax({
                type: "get",
                url: "https://autumnfish.cn/mv/url?id=" + mvid,
                success: function (data) {
                    var mvUrl = data.data.url;
                    $("#mvUrl").prop("src",mvUrl);
                    $("#video_con").show();
                },
                error:function(err){
                    alert("系统异常，请联系管理员！");
                }
            });
        }
        // 关闭mv
        var hideVideo_con = function(){
            $("#video_con").hide();
            $("#mvUrl").prop("src","");
        }

    </script>
</body>
</html>